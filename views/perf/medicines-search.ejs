<%- include('../partials/header') %>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="max-w-4xl mx-auto">
  <h2 class="text-2xl font-semibold mb-4">Performance: Medicine Search</h2>
  
  <form id="perfForm" class="bg-white p-6 rounded shadow mb-8">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div>
        <label class="block text-sm font-medium text-gray-700"
          >Medicine Name</label
        >
        <input
          name="searchTerm"
          value="Aspirin"
          class="mt-1 w-full rounded border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"
        />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700"
          >Supplier Name</label
        >
        <input
          name="supplierName"
          placeholder="e.g. ACME Pharma"
          class="mt-1 w-full rounded border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"
        />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700"
          >Expiry Before</label
        >
        <input
          type="date"
          name="expiryBefore"
          class="mt-1 w-full rounded border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"
        />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Min Price</label>
        <input
          type="number"
          step="0.01"
          name="minPrice"
          class="mt-1 w-full rounded border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"
        />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Max Price</label>
        <input
          type="number"
          step="0.01"
          name="maxPrice"
          class="mt-1 w-full rounded border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"
        />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700"
          >Stock &lt; (threshold)</label
        >
        <input
          type="number"
          name="stockLessThan"
          class="mt-1 w-full rounded border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"
        />
      </div>
    </div>

    <div class="mt-4">
      <label class="block text-sm font-medium text-gray-700 mb-2"
        >Choose Tests</label
      >
      <div class="flex flex-wrap gap-4">
        <label class="inline-flex items-center"
          ><input
            type="checkbox"
            name="tests"
            value="basic"
            checked
            class="mr-2"
          />Basic name LIKE search</label
        >
        <label class="inline-flex items-center"
          ><input
            type="checkbox"
            name="tests"
            value="joinSupplier"
            checked
            class="mr-2"
          />Join with Supplier (JOIN)</label
        >
        <label class="inline-flex items-center"
          ><input
            type="checkbox"
            name="tests"
            value="countBySupplier"
            class="mr-2"
          />Count by Supplier (GROUP BY)</label
        >
        <label class="inline-flex items-center"
          ><input
            type="checkbox"
            name="tests"
            value="avgPrice"
            class="mr-2"
          />Average Price (AGGREGATE)</label
        >
        <label class="inline-flex items-center"
          ><input
            type="checkbox"
            name="tests"
            value="ordersJoin"
            class="mr-2"
          />Join with Orders (JOIN)</label
        >
      </div>
    </div>

    <div class="mt-4 flex items-center gap-4">
      <button
        type="submit"
        class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700"
      >
        Run Test
      </button>
      <button
        type="button"
        id="resetBtn"
        class="bg-gray-200 text-gray-800 px-3 py-2 rounded"
      >
        Reset
      </button>
    </div>
  </form>

  <div class="bg-white p-6 rounded shadow">
    <canvas id="perfChart" class="w-full"> </canvas>
  </div>

  <div id="results" class="mt-8 space-y-6"></div>
</div>
<script>
  function formatResults(results) {
    if (!results || results.length === 0) return "<p>No data</p>";

    const sample = results[0];
    const keys = Object.keys(sample);

    if (
      keys.includes("name") &&
      (keys.includes("price") || keys.includes("stock"))
    ) {
      let html =
        '<table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr>';
      html +=
        '<th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase">Name</th>';
      html +=
        '<th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase">Supplier</th>';
      html +=
        '<th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase">Price</th>';
      html +=
        '<th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase">Stock</th>';
      html +=
        '<th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase">Expiry</th>';
      html += '</tr></thead><tbody class="bg-white divide-y divide-gray-200">';
      results.slice(0, 5).forEach((m) => {
        html += `<tr>
          <td class="px-2 py-1 whitespace-nowrap text-sm">${m.name || ""}</td>
          <td class="px-2 py-1 whitespace-nowrap text-sm">${
            m.Supplier ? m.Supplier.name : m.supplierName || ""
          }</td>
          <td class="px-2 py-1 whitespace-nowrap text-sm">${
            m.price != null ? "â‚¹" + m.price : ""
          }</td>
          <td class="px-2 py-1 whitespace-nowrap text-sm">${
            m.stock != null ? m.stock : ""
          }</td>
          <td class="px-2 py-1 whitespace-nowrap text-sm">${
            m.expiryDate ? new Date(m.expiryDate).toLocaleDateString() : ""
          }</td>
        </tr>`;
      });
      html += "</tbody></table>";
      return html;
    } else if (keys.includes("name") && keys.includes("contact")) {
      let html =
        '<table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr>';
      html +=
        '<th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase">Name</th>';
      html +=
        '<th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase">Contact</th>';
      html +=
        '<th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase">Email</th>';
      html += '</tr></thead><tbody class="bg-white divide-y divide-gray-200">';
      results.slice(0, 5).forEach((s) => {
        html += `<tr>
          <td class="px-2 py-1 whitespace-nowrap text-sm">${s.name || ""}</td>
          <td class="px-2 py-1 whitespace-nowrap text-sm">${
            s.contact || ""
          }</td>
          <td class="px-2 py-1 whitespace-nowrap text-sm">${s.email || ""}</td>
        </tr>`;
      });
      html += "</tbody></table>";
      return html;
    } else if (keys.includes("id") && keys.includes("status")) {
      let html =
        '<table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr>';
      html +=
        '<th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase">ID</th>';
      html +=
        '<th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase">Status</th>';
      html +=
        '<th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase">Created</th>';
      html += '</tr></thead><tbody class="bg-white divide-y divide-gray-200">';
      results.slice(0, 5).forEach((o) => {
        html += `<tr>
          <td class="px-2 py-1 whitespace-nowrap text-sm">${o.id || ""}</td>
          <td class="px-2 py-1 whitespace-nowrap text-sm">${o.status || ""}</td>
          <td class="px-2 py-1 whitespace-nowrap text-sm">${
            o.createdAt ? new Date(o.createdAt).toLocaleString() : ""
          }</td>
        </tr>`;
      });
      html += "</tbody></table>";
      return html;
    } else if (keys.length === 1 && keys[0].toLowerCase().includes("count")) {
      return `<p class="text-sm">Count: ${sample[keys[0]]}</p>`;
    } else if (keys.length === 1 && keys[0].toLowerCase().includes("avg")) {
      return `<p class="text-sm">Average: ${parseFloat(sample[keys[0]]).toFixed(
        2
      )}</p>`;
    } else if (keys.length === 1 && keys[0].toLowerCase().includes("sum")) {
      return `<p class="text-sm">Total: ${sample[keys[0]]}</p>`;
    } else {
      return `<pre class="text-xs bg-gray-100 p-2 mt-2 rounded overflow-auto max-h-40">${JSON.stringify(
        results.slice(0, 5),
        null,
        2
      )}${results.length > 5 ? "... and more" : ""}</pre>`;
    }
  }

  let perfChartInstance = null;

  document.getElementById("perfForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const f = e.target.elements;
    const payload = {
      searchTerm: f.searchTerm.value || null,
      supplierName: f.supplierName.value || null,
      minPrice: f.minPrice.value ? parseFloat(f.minPrice.value) : null,
      maxPrice: f.maxPrice.value ? parseFloat(f.maxPrice.value) : null,
      stockLessThan: f.stockLessThan.value
        ? parseInt(f.stockLessThan.value, 10)
        : null,
      expiryBefore: f.expiryBefore.value || null,
      tests: Array.from(
        document.querySelectorAll('input[name="tests"]:checked')
      ).map((i) => i.value),
    };

    const response = await fetch("/perf/medicines-search/run", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
    });
    const data = await response.json();

    const resultsDiv = document.getElementById("results");
    resultsDiv.innerHTML = `<h3 class="text-lg font-semibold mb-4">Performance Test Results</h3>`;

    if (!data || !Array.isArray(data.results)) {
      resultsDiv.innerHTML +=
        '<p class="text-red-600">Unexpected response from server.</p>';
      return;
    }

    data.results.slice(0, 5).forEach((result, index) => {
      const div = document.createElement("div");
      div.className = "bg-white p-6 rounded shadow";
      if (result.error) {
        div.innerHTML = `
          <h4 class="text-md font-semibold mb-2">${index + 1}. ${
          result.name
        }</h4>
          <p class="text-red-600">Error: ${result.error}</p>
        `;
      } else {
        div.innerHTML = `
          <h4 class="text-md font-semibold mb-2">${index + 1}. ${
          result.name
        }</h4>
          <p class="text-sm text-gray-700 mb-2">
            <b>Without Index:</b> ${result.withoutIndex.time} ms, found ${
          result.withoutIndex.results.length
        } records<br>
            <b>With Index:</b> ${result.withIndex.time} ms, found ${
          result.withIndex.results.length
        } records
          </p>
          <details class="mt-4">
            <summary class="cursor-pointer text-sm font-medium">View Data (Without Index)</summary>
            ${formatResults(result.withoutIndex.results)}
          </details>
          <details class="mt-2">
            <summary class="cursor-pointer text-sm font-medium">View Data (With Index)</summary>
            ${formatResults(result.withIndex.results)}
          </details>
        `;
      }
      resultsDiv.appendChild(div);
    });

    const chartLimit = 10;
    const chartData = data.results.slice(0, chartLimit).filter((r) => !r.error);
    if (chartData.length) {
      const labels = chartData.map((r) => r.name);
      const withoutTimes = chartData.map(
        (r) => Number(r.withoutIndex.time) || 0
      );
      const withTimes = chartData.map((r) => Number(r.withIndex.time) || 0);

      const allTimes = withoutTimes.concat(withTimes);
      const maxTime = Math.max(...allTimes, 1);
      const suggestedMax = Math.ceil(maxTime * 1.15);

      const ctx = document.getElementById("perfChart");
      if (perfChartInstance) {
        perfChartInstance.destroy();
      }
      perfChartInstance = new Chart(ctx, {
        type: "bar",
        data: {
          labels,
          datasets: [
            {
              label: "Without Index (ms)",
              data: withoutTimes,
              backgroundColor: "rgba(255, 99, 132, 0.4)",
              borderColor: "rgba(255, 99, 132, 1)",
              borderWidth: 1,
            },
            {
              label: "With Index (ms)",
              data: withTimes,
              backgroundColor: "rgba(75, 192, 192, 0.4)",
              borderColor: "rgba(75, 192, 192, 1)",
              borderWidth: 1,
            },
          ],
        },
        options: {
          scales: {
            y: { beginAtZero: true, suggestedMax },
          },
          responsive: true,
          plugins: { legend: { position: "top" } },
        },
      });
    } else {
      if (perfChartInstance) {
        perfChartInstance.destroy();
        perfChartInstance = null;
      }
    }
  });

  document.getElementById("resetBtn").addEventListener("click", () => {
    document.getElementById("perfForm").reset();
  });
</script>

<%- include('../partials/footer') %>
